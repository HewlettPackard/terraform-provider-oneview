sudo: required

services:
  - docker

language: go
go_import_path: github.com/HewlettPackard/terraform-provider-oneview

go:
- 1.8

env:
  global:
    - BUILDNAME=terraform-provider-oneview
    - BINS_DEST=./bins
    - CGO_ENABLED=0
    - GOARCH=amd64
    - REPO=$DOCKER_USERNAME/terraform-provider-oneview
    - TAG=$(if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo "branch-${TRAVIS_BRANCH}"; fi)
    - UNFORMATTED=$(find . -type f -name "*.go" -not -path "./vendor/*" | sed "s|^\./||" | xargs gofmt -l)

install:
  - bash download_hashicorp_bins.sh $BINS_DEST

before_script:
  - if ! [ -z "$UNFORMATTED" ]; then
      echo -e "Go files must be formatted with gofmt. Please run:";
      for fn in $UNFORMATTED; do
        echo -e "  gofmt -w $PWD/$fn";
      done;
      exit 1;
    fi

script:
  - go vet $(go list ./... | grep -v '/vendor/')
  - go test -v $(go list ./... | grep -v '/vendor/')
  - GOOS=windows go build -a -tags netgo -ldflags '-s -w' -o $BINS_DEST/windows/$BUILDNAME.exe
  - GOOS=linux go build -a -tags netgo -ldflags '-s -w' -o $BINS_DEST/linux/$BUILDNAME
  - GOOS=darwin go build -a -tags netgo -ldflags '-s -w' -o $BINS_DEST/macos/$BUILDNAME
  - docker build -f Dockerfile -t $REPO:$TAG .
  - docker build -f Dockerfile.scratch -t $REPO:scratch-$TAG .

after_success:
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
  - docker push $REPO
